from scipy.io import readsav
import pandas as pd
import numpy as np
import matplotlib
import matplotlib.pyplot as plt
from matplotlib.colors import LogNorm
from util import generate_mass_bins
from sunpy.time import TimeRange
import datetime
from heliopy.data.cassini import caps_ibs
from cassinipy.caps.mssl import *
from cassinipy.caps.util import *
matplotlib.rcParams.update({'font.size': 15})

ibs_upperenergyvalues = np.array([9981.8203125 , 9817.87011719, 9656.59960938, 9497.98046875,
       9341.96972656, 9188.51953125, 9037.59960938, 8889.15039062,
       8743.13964844, 8599.53027344, 8458.26953125, 8319.33984375,
       8182.68994141, 8048.27978516, 7916.08007812, 7786.06005859,
       7658.16992188, 7532.37011719, 7408.64990234, 7286.95996094,
       7167.25976562, 7049.54003906, 6933.74023438, 6819.85009766,
       6707.83007812, 6597.64990234, 6489.27978516, 6382.68994141,
       6277.85009766, 6174.72998047, 6073.31005859, 5973.54980469,
       5875.43017578, 5778.91992188, 5684.        , 5590.62988281,
       5498.79980469, 5408.47998047, 5319.64013672, 5232.27001953,
       5146.31982422, 5061.79003906, 4978.64990234, 4896.87011719,
       4816.43017578, 4737.31982422, 4659.50976562, 4582.97021484,
       4507.68994141, 4433.64990234, 4360.83007812, 4289.20019531,
       4218.74023438, 4149.45019531, 4081.29003906, 4014.25      ,
       3948.31005859, 3883.45996094, 3819.66992188, 3756.92993164,
       3695.2199707 , 3634.5300293 , 3574.83007812, 3516.11010742,
       3458.35009766, 3401.55004883, 3345.66992188, 3290.7199707 ,
       3236.66992188, 3183.5       , 3131.20996094, 3079.7800293 ,
       3029.18994141, 2979.42993164, 2930.48999023, 2882.36010742,
       2835.01000977, 2788.44995117, 2742.64990234, 2697.60009766,
       2653.29003906, 2609.69995117, 2566.84008789, 2524.67993164,
       2483.20996094, 2442.41992188, 2402.30004883, 2362.84008789,
       2324.0300293 , 2285.85009766, 2248.31005859, 2211.37988281,
       2175.05004883, 2139.33007812, 2104.18994141, 2069.62011719,
       2035.63000488, 2002.18994141, 1969.31005859, 1936.95996094,
       1905.14001465, 1873.84997559, 1843.06994629, 1812.80004883,
       1783.02001953, 1753.72998047, 1724.93005371, 1696.58996582,
       1668.72998047, 1641.31994629, 1614.35998535, 1587.83996582,
       1561.76000977, 1536.09997559, 1510.86999512, 1486.06005859,
       1461.65002441, 1437.64001465, 1414.02001953, 1390.80004883,
       1367.94995117, 1345.47998047, 1323.38000488, 1301.65002441,
       1280.26000977, 1259.23999023, 1238.55004883, 1218.20996094,
       1198.19995117, 1178.52001953, 1159.16003418, 1140.11999512,
       1121.39001465, 1102.9699707 , 1084.84997559, 1067.04003906,
       1049.51000977, 1032.27001953, 1015.30999756,  998.64001465,
        982.22998047,  966.09997559,  950.22998047,  934.61999512,
        919.27001953,  904.16998291,  889.32000732,  874.71002197,
        860.34002686,  846.21002197,  832.30999756,  818.64001465,
        805.19000244,  791.9699707 ,  778.96002197,  766.15997314,
        753.58001709,  741.20001221,  729.0300293 ,  717.04998779,
        705.27001953,  693.69000244,  682.29998779,  671.09002686,
        660.07000732,  649.2199707 ,  638.55999756,  628.07000732,
        617.75      ,  607.60998535,  597.63000488,  587.80999756,
        578.15002441,  568.65997314,  559.32000732,  550.13000488,
        541.09002686,  532.21002197,  523.46002197,  514.86999512,
        506.41000366,  498.08999634,  489.91000366,  481.85998535,
        473.95001221,  466.16000366,  458.51000977,  450.97000122,
        443.57000732,  436.27999878,  429.10998535,  422.07000732,
        415.13000488,  408.30999756,  401.60998535,  395.01000977,
        388.51998901,  382.14001465,  375.85998535,  369.69000244,
        363.61999512,  357.6499939 ,  351.76998901,  345.98999023,
        340.30999756,  334.72000122,  329.22000122,  323.80999756,
        318.48999023,  313.26000977,  308.11999512,  303.05999756,
        298.07998657,  293.17999268,  288.36999512,  283.63000488,
        278.97000122,  274.39001465,  269.88000488,  265.45001221,
        261.08999634,  256.79998779,  252.58000183,  248.42999268,
        244.3500061 ,  240.33999634,  236.38999939,  232.50999451,
        228.69000244,  224.92999268,  221.24000549,  217.6000061 ,
        214.02999878,  210.50999451,  207.05999756,  203.66000366,
        200.30999756,  197.02000427,  193.77999878,  190.6000061 ,
        187.47000122,  184.38999939,  181.36000061,  178.38000488,
        175.44999695,  172.57000732,  169.74000549,  166.94999695,
        164.21000671,  161.50999451,  158.86000061,  156.25      ,
        153.67999268,  151.16000366,  148.66999817])


ibscalib = readsav('calib/ibsdisplaycalib.dat')
sngcalib = readsav('calib/sngdisplaycalib.dat')



start = datetime.datetime(2006,1,25,7)
end = datetime.datetime(2006,1,25,8)
tr = TimeRange(start,end)


sngdata = readsav("data/sng/sngres_25-jan-2006.dat")
sngtimeseries_full = generate_timeseries_caps_mssl(sngdata, 9, "sngdata")
sngtimeseries = sngtimeseries_full.truncate(tr)

ibstimeseries = caps_ibs(start, end, 1)
print(ibstimeseries.data.columns)



fig, (ibsax, sngax) = plt.subplots(2,sharex="all",sharey="all")
ibsax.pcolormesh(ibstimeseries.index, np.flip(ibs_upperenergyvalues), ibstimeseries.data.to_numpy().T, norm=LogNorm(vmin=100, vmax=1e4), cmap='viridis')
sngax.pcolormesh(sngtimeseries.index, sngcalib['sngearray'], sngtimeseries.data.to_numpy().T, norm=LogNorm(vmin=50, vmax=1e4), cmap='viridis')
sngax.set_yscale("log")
ibsax.set_ylabel("IBS Fan 2 \n ev/q")
sngax.set_ylabel("SNG summed \n ev/q")

plt.show()